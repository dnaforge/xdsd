<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>src.optimization.simulated_annealing &mdash; DSDui  documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> DSDui
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mainmodules.html">Main modules</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">DSDui</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>src.optimization.simulated_annealing</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for src.optimization.simulated_annealing</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randrange</span>

<span class="kn">from</span> <span class="nn">PyQt5.QtWidgets</span> <span class="kn">import</span> <span class="n">QApplication</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">exp</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">uniform</span>

<span class="kn">import</span> <span class="nn">src.utils.config</span>
<span class="kn">from</span> <span class="nn">src.optimization.energy_function</span> <span class="kn">import</span> <span class="n">E</span>

<span class="c1"># from src.utils.config import COOL_CONST, END_TEMP_CONST, INCR_CONST, START_TEMP_CONST, \</span>
<span class="c1">#     get_vector_length, DOMAIN_LEN, get_side</span>

<span class="c1"># if len(sys.argv) &gt; 1 and &quot;OGDF_INSTALL_DIR&quot; not in os.environ:</span>
<span class="c1">#     os.environ[&quot;OGDF_INSTALL_DIR&quot;] = sys.argv[1]</span>
<span class="c1"># elif &quot;OGDF_INSTALL_DIR&quot; not in os.environ:</span>
<span class="c1">#     os.environ[&quot;OGDF_INSTALL_DIR&quot;] = &quot;./ogdf/cmake-build-release&quot;</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;OGDF_INSTALL_DIR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;../ogdf/cmake-build-release&quot;</span>

<span class="kn">from</span> <span class="nn">ogdf_python</span> <span class="kn">import</span> <span class="n">ogdf</span><span class="p">,</span> <span class="n">cppinclude</span>

<span class="n">cppinclude</span><span class="p">(</span><span class="s2">&quot;ogdf/basic/GraphCopy.h&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="optimize"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.optimize">[docs]</a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">GA</span><span class="p">,</span> <span class="n">graph_domain_pairs</span><span class="p">,</span> <span class="n">graph_loops</span><span class="p">,</span> <span class="n">signals</span><span class="p">,</span> <span class="n">species_no</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the main loop of the simulated annealing</span>

<span class="sd">    :param G: Graph representation of the species, holds info on the embedding</span>
<span class="sd">    :param GA: Graph attributes of G, holds info on the placements of the nodes</span>
<span class="sd">    :param graph_domain_pairs: Dictionary with the pairs of domains and their constituent nodes</span>
<span class="sd">    :param graph_loops: Dictionary with the endings of the loops in the species and their constituent nodes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># transfer the graph attributes to the copy so that it can be manipulated</span>
    <span class="n">G_copy</span> <span class="o">=</span> <span class="n">ogdf</span><span class="o">.</span><span class="n">GraphCopy</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="n">GA_copy</span> <span class="o">=</span> <span class="n">ogdf</span><span class="o">.</span><span class="n">GraphAttributes</span><span class="p">(</span><span class="n">G_copy</span><span class="p">,</span> <span class="n">ogdf</span><span class="o">.</span><span class="n">GraphAttributes</span><span class="o">.</span><span class="n">all</span><span class="p">)</span>
    <span class="n">GA</span><span class="o">.</span><span class="n">transferToCopy</span><span class="p">(</span><span class="n">GA_copy</span><span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_copy</span><span class="p">,</span> <span class="n">GA_copy</span><span class="p">)</span>
    <span class="n">set_bond_targets</span><span class="p">(</span><span class="n">GA_copy</span><span class="p">,</span> <span class="n">graph_domain_pairs</span><span class="p">)</span>
    <span class="n">energy_history</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
    <span class="c1"># total energy, components: loop ends distance, domains lengths, pair placement</span>
    <span class="n">energy</span><span class="p">,</span> <span class="n">components</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">graph_domain_pairs</span><span class="p">,</span> <span class="n">graph_loops</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">energy_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
    <span class="n">energy_history</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">energy_history</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">energy_history</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">best_state</span> <span class="o">=</span> <span class="n">state</span>
    <span class="n">best_energy</span> <span class="o">=</span> <span class="n">energy</span>

    <span class="n">T</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">START_TEMP_CONST</span>
    <span class="n">T_end</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">END_TEMP_CONST</span>
    <span class="n">iterations_number</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">INITIAL_ITER_NO</span>
    <span class="n">increment</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">INCR_CONST</span>

    <span class="n">worse_energy</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">length_factor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># main loop of the simulated annealing</span>
    <span class="k">while</span> <span class="n">T</span> <span class="o">&gt;=</span> <span class="n">T_end</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">state</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">best_state</span><span class="p">,</span> <span class="n">best_energy</span><span class="p">,</span> <span class="n">energy_history</span> <span class="o">=</span> <span class="n">optimize_one_iteration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span>
                                                                                        <span class="n">best_state</span><span class="p">,</span> <span class="n">best_energy</span><span class="p">,</span>
                                                                                        <span class="n">iterations_number</span><span class="p">,</span>
                                                                                        <span class="n">graph_domain_pairs</span><span class="p">,</span>
                                                                                        <span class="n">graph_loops</span><span class="p">,</span> <span class="n">energy_history</span><span class="p">,</span>
                                                                                        <span class="n">length_factor</span><span class="p">)</span>

        <span class="c1"># decrease temperature</span>
        <span class="n">T</span> <span class="o">*=</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">COOL_CONST</span>
        <span class="c1"># increase the influence of domain and loop length</span>
        <span class="n">length_factor</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="n">T_end</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">START_TEMP_CONST</span><span class="o">-</span><span class="n">T_end</span><span class="p">)</span>
        <span class="c1"># decrease the number of iterations at the given temperature level</span>
        <span class="n">iterations_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.935</span> <span class="o">*</span> <span class="n">iterations_number</span><span class="p">)</span>

        <span class="c1"># restarting the annealing in case of a bad well</span>
        <span class="k">if</span> <span class="n">energy</span> <span class="o">&gt;</span> <span class="n">best_energy</span><span class="p">:</span>
            <span class="n">worse_energy</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">worse_energy</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">best_state</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">best_energy</span>
            <span class="n">energy_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
            <span class="n">worse_energy</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">signals</span><span class="o">.</span><span class="n">update</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">species_no</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">QApplication</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>

    <span class="c1"># transfer the new attributes to the graph (attributes = placements of the nodes)</span>
    <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transferToOriginal</span><span class="p">(</span><span class="n">GA</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">energy_history</span></div>


<div class="viewcode-block" id="optimize_one_iteration"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.optimize_one_iteration">[docs]</a><span class="k">def</span> <span class="nf">optimize_one_iteration</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">increment</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">best_state</span><span class="p">,</span> <span class="n">best_energy</span><span class="p">,</span> <span class="n">iterations_number</span><span class="p">,</span> <span class="n">graph_domain_pairs</span><span class="p">,</span>
                           <span class="n">graph_loops</span><span class="p">,</span> <span class="n">energy_history</span><span class="p">,</span> <span class="n">length_factor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs state change in the given temperature in simulated annealing</span>

<span class="sd">    :param state: Species object to be optimized</span>
<span class="sd">    :param energy: Value of the initial state&#39;s energy function E</span>
<span class="sd">    :param increment: Upper bound on the movement of species&#39; hinges (in pixels)</span>
<span class="sd">    :param T: Current temperature value</span>
<span class="sd">    :param best_state: Reference value for the best state after the optimization (initially equal to state)</span>
<span class="sd">    :param best_energy: Reference value for the energy of the best state  after the optimization (initially equal to energy)</span>
<span class="sd">    :param iterations_number: Number of state changes to perform (moves)</span>
<span class="sd">    :param graph_domain_pairs: Dictionary with the pairs of domains and their constituent nodes</span>
<span class="sd">    :param graph_loops: Dictionary with the endings of the loops in the species and their constituent nodes</span>
<span class="sd">    :param energy_history: Array holding the history of all the energy components (for plotting purposes)</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations_number</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">increment</span><span class="p">)</span>
        <span class="n">set_bond_targets</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">graph_domain_pairs</span><span class="p">)</span>
        <span class="c1"># energy components: distance between the ends of the loops, domain lengths, pair placement</span>
        <span class="n">next_energy</span><span class="p">,</span> <span class="n">components</span> <span class="o">=</span> <span class="n">E</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">graph_domain_pairs</span><span class="p">,</span> <span class="n">graph_loops</span><span class="p">,</span> <span class="n">length_factor</span><span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">next_energy</span> <span class="o">-</span> <span class="n">energy</span>

        <span class="k">if</span> <span class="n">diff</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">uniform</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">diff</span> <span class="o">/</span> <span class="n">T</span><span class="p">):</span>
            <span class="n">energy</span> <span class="o">=</span> <span class="n">next_energy</span>
            <span class="n">energy_history</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
            <span class="n">energy_history</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">energy_history</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">energy_history</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">components</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">energy</span> <span class="o">&lt;</span> <span class="n">best_energy</span><span class="p">:</span>
                <span class="n">best_energy</span> <span class="o">=</span> <span class="n">energy</span>
                <span class="n">best_state</span> <span class="o">=</span> <span class="n">state</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unmove</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">best_state</span><span class="p">,</span> <span class="n">best_energy</span><span class="p">,</span> <span class="n">energy_history</span></div>


<div class="viewcode-block" id="decrease_temperature"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.decrease_temperature">[docs]</a><span class="k">def</span> <span class="nf">decrease_temperature</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">cool</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cooling schedule of the optimization</span>

<span class="sd">    :param T: Current temperature</span>
<span class="sd">    :param cool: Cooling factor</span>
<span class="sd">    :return: New temperature</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">T</span> <span class="o">*=</span> <span class="n">cool</span>
    <span class="k">return</span> <span class="n">T</span></div>


<div class="viewcode-block" id="move"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.move">[docs]</a><span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">increment</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs the state change in the simulated annealing</span>

<span class="sd">    :param state: Species object to be changed</span>
<span class="sd">    :param increment: Upper bound on the movement of species&#39; hinges (in pixels)</span>
<span class="sd">    :return: New Species object after the change</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span><span class="p">,</span> <span class="n">GA</span> <span class="o">=</span> <span class="n">state</span>

    <span class="n">node</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">chooseNode</span><span class="p">()</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="n">increment</span><span class="p">,</span> <span class="n">increment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">randrange</span><span class="p">(</span><span class="o">-</span><span class="n">increment</span><span class="p">,</span> <span class="n">increment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">GA</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span>
    <span class="n">GA</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span>

    <span class="k">return</span> <span class="n">node</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span></div>


<div class="viewcode-block" id="unmove"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.unmove">[docs]</a><span class="k">def</span> <span class="nf">unmove</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Undoes the state change in the simulated annealing</span>

<span class="sd">    :param state: Species object to be changed</span>
<span class="sd">    :param node: Node to be moved back</span>
<span class="sd">    :param dx: X increment</span>
<span class="sd">    :param dy: Y increment</span>
<span class="sd">    :return: New Species object after the change</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">G</span><span class="p">,</span> <span class="n">GA</span> <span class="o">=</span> <span class="n">state</span>

    <span class="n">GA</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dx</span>
    <span class="n">GA</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dy</span></div>


<div class="viewcode-block" id="set_bond_targets"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.set_bond_targets">[docs]</a><span class="k">def</span> <span class="nf">set_bond_targets</span><span class="p">(</span><span class="n">GA</span><span class="p">,</span> <span class="n">graph_domain_pairs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the designated placement of the pairs in relation to each other, i.e. the beginning of one domain is at</span>
<span class="sd">    DOMAIN/sqrt(2) orthogonal distance from the end of the second domain in a pair</span>

<span class="sd">    :param GA: Graph attributes holding info on the nodes. The resulting placements are wrote into nodes&#39; labels in</span>
<span class="sd">    the format !bond_id first_place second_place</span>
<span class="sd">    :param graph_domain_pairs: Dictionary with all the pair in the species</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reset the target placements (after the movement)</span>
    <span class="k">for</span> <span class="n">bond</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">graph_domain_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># add the targets to the nodes&#39; labels</span>
    <span class="k">for</span> <span class="n">bond</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">graph_domain_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">first_pair</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">second_pair</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># 3&#39; and 5&#39; end of the first domain</span>
        <span class="n">first_node1</span> <span class="o">=</span> <span class="p">[</span><span class="n">GA</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">first_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">GA</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">first_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
        <span class="n">first_node2</span> <span class="o">=</span> <span class="p">[</span><span class="n">GA</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">first_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">GA</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">first_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

        <span class="c1"># 3&#39; and 5&#39; end of the second domain</span>
        <span class="n">second_node2</span> <span class="o">=</span> <span class="p">[</span><span class="n">GA</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">second_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">GA</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">second_pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="n">second_node1</span> <span class="o">=</span> <span class="p">[</span><span class="n">GA</span><span class="o">.</span><span class="n">x</span><span class="p">(</span><span class="n">second_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">GA</span><span class="o">.</span><span class="n">y</span><span class="p">(</span><span class="n">second_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># get the candidates for the bond targets and the vectors to them from the domains</span>
        <span class="n">first_candidate</span><span class="p">,</span> <span class="n">first_perp</span> <span class="o">=</span> <span class="n">get_bond_target_candidate</span><span class="p">(</span><span class="n">first_node1</span><span class="p">,</span> <span class="n">first_node2</span><span class="p">)</span>
        <span class="n">second_candidate</span><span class="p">,</span> <span class="n">second_perp</span> <span class="o">=</span> <span class="n">get_bond_target_candidate</span><span class="p">(</span><span class="n">second_node1</span><span class="p">,</span> <span class="n">second_node2</span><span class="p">)</span>

        <span class="c1"># check how many cosines are positive == if the shape between the pairs is a valid quadrilateral</span>
        <span class="c1"># (where only one of the angles can be greater than 180 degrees)</span>
        <span class="n">convexity</span> <span class="o">=</span> <span class="n">get_pair_convexity</span><span class="p">(</span><span class="n">first_candidate</span><span class="p">,</span> <span class="n">second_candidate</span><span class="p">,</span>
                                       <span class="n">first_node1</span><span class="p">,</span> <span class="n">first_node2</span><span class="p">,</span> <span class="n">second_node1</span><span class="p">,</span> <span class="n">second_node2</span><span class="p">)</span>
        <span class="c1"># flip the bond side in both domains</span>
        <span class="k">if</span> <span class="n">convexity</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">first_perp</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">first_perp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">first_perp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">second_perp</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">second_perp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">second_perp</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="c1"># write the bond coordinates to the nodes&#39; labels</span>
        <span class="n">write_bond_targets</span><span class="p">(</span><span class="n">GA</span><span class="p">,</span> <span class="n">bond</span><span class="p">,</span> <span class="n">first_pair</span><span class="p">,</span> <span class="n">first_perp</span><span class="p">)</span>
        <span class="n">write_bond_targets</span><span class="p">(</span><span class="n">GA</span><span class="p">,</span> <span class="n">bond</span><span class="p">,</span> <span class="n">second_pair</span><span class="p">,</span> <span class="n">second_perp</span><span class="p">)</span></div>


<div class="viewcode-block" id="write_bond_targets"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.write_bond_targets">[docs]</a><span class="k">def</span> <span class="nf">write_bond_targets</span><span class="p">(</span><span class="n">GA</span><span class="p">,</span> <span class="n">bond</span><span class="p">,</span> <span class="n">pair</span><span class="p">,</span> <span class="n">perp</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the coordinates of the bond targets to the nodes&#39; labels which are determined by the perpendicular vector</span>

<span class="sd">    :param GA: Graph attributes holding the nodes&#39; labels</span>
<span class="sd">    :param bond: Bond id for the pair</span>
<span class="sd">    :param pair: Domain for which the bonds are determined</span>
<span class="sd">    :param perp: Perpendicular vector to the pair domain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">bond</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">bond</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">bond</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GA</span><span class="o">.</span><span class="n">label</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="s2">&quot;!&quot;</span> <span class="o">+</span> <span class="n">bond</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_pair_convexity"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.get_pair_convexity">[docs]</a><span class="k">def</span> <span class="nf">get_pair_convexity</span><span class="p">(</span><span class="n">first_candidate</span><span class="p">,</span> <span class="n">second_candidate</span><span class="p">,</span> <span class="n">first_node1</span><span class="p">,</span> <span class="n">first_node2</span><span class="p">,</span> <span class="n">second_node1</span><span class="p">,</span> <span class="n">second_node2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check how many cosines of the angles between vector from the node to the paired node and the node to the candidate place for the paired node are positive i.e. if the shape between the pairs is a valid quadrilateral (where only one of the angles can be greater than 180 degrees).</span>

<span class="sd">    :param first_candidate: Candidate placement for the bond target for the first domain in the pair</span>
<span class="sd">    :param second_candidate: Candidate placement for the bond target for the second domain in the pair</span>
<span class="sd">    :param first_node1: Node denoting the beginning of the first domain in the pair</span>
<span class="sd">    :param first_node2: Node denoting the end of the first domain in the pair</span>
<span class="sd">    :param second_node1: Node denoting the beginning of the second domain in the pair</span>
<span class="sd">    :param second_node2: Node denoting the end of the first second in the pair</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">get_side_convexity</span><span class="p">(</span><span class="n">first_candidate</span><span class="p">,</span> <span class="n">first_node1</span><span class="p">,</span> <span class="n">first_node2</span><span class="p">,</span> <span class="n">second_node1</span><span class="p">,</span> <span class="n">second_node2</span><span class="p">)</span> <span class="o">+</span> \
           <span class="n">get_side_convexity</span><span class="p">(</span><span class="n">second_candidate</span><span class="p">,</span> <span class="n">second_node1</span><span class="p">,</span> <span class="n">second_node2</span><span class="p">,</span> <span class="n">first_node1</span><span class="p">,</span> <span class="n">first_node2</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_side_convexity"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.get_side_convexity">[docs]</a><span class="k">def</span> <span class="nf">get_side_convexity</span><span class="p">(</span><span class="n">candidate</span><span class="p">,</span> <span class="n">first_node1</span><span class="p">,</span> <span class="n">first_node2</span><span class="p">,</span> <span class="n">second_node1</span><span class="p">,</span> <span class="n">second_node2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the sign of the cosine of the angle between vector from the node to the paired node and the node to the candidate place for the paired node</span>

<span class="sd">    :param candidate: Candidate placement for the bond target for the domain in the pair</span>
<span class="sd">    :param first_node1: Node denoting the beginning of the first domain in the pair</span>
<span class="sd">    :param first_node2: Node denoting the end of the first domain in the pair</span>
<span class="sd">    :param second_node1: Node denoting the beginning of the second domain in the pair</span>
<span class="sd">    :param second_node2: Node denoting the end of the first second in the pair</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the first vector to candidate is the same for both ends of the domain</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_cos</span><span class="p">([</span><span class="n">candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                        <span class="p">[</span><span class="n">second_node2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second_node2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node1</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> \
           <span class="nb">int</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_cos</span><span class="p">([</span><span class="n">candidate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">candidate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node1</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                        <span class="p">[</span><span class="n">second_node1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">second_node1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">first_node2</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_bond_target_candidate"><a class="viewcode-back" href="../../../src.optimization.html#src.optimization.simulated_annealing.get_bond_target_candidate">[docs]</a><span class="k">def</span> <span class="nf">get_bond_target_candidate</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span> <span class="n">node2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the candidate placement of the bond target for the domain which ends are denoted by the parameters</span>

<span class="sd">    :param node1: First end of the considered domain</span>
<span class="sd">    :param node2: Second end of the considered domain</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="p">[</span><span class="n">node2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">node1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">node1</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">direction_len</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_vector_length</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
    <span class="n">direction_norm</span> <span class="o">=</span> <span class="p">[</span><span class="n">direction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">direction_len</span> <span class="o">*</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DOMAIN_LEN</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                      <span class="n">direction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">direction_len</span> <span class="o">*</span> <span class="n">src</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">DOMAIN_LEN</span> <span class="o">/</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
    <span class="n">perp</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="n">direction_norm</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">direction_norm</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="k">return</span> <span class="p">[</span><span class="n">node1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">perp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">node1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">perp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">perp</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Malgorzata Nowicka.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>